# Istio Gateway for POC
# Use TLS PASSTHROUGH so WSO2 services terminate TLS themselves.
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: wso2-gateway
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 443
        name: tls
        protocol: TLS
      tls:
        mode: PASSTHROUGH
      hosts:
        - "apim.local"
        - "gw.local"
---
# VirtualService for APIM Control Plane (SNI based routing)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: apim-vs
  namespace: wso2
spec:
  hosts:
    - "apim.local"
  gateways:
    - istio-system/wso2-gateway
  tls:
    - match:
        - port: 443
          sniHosts:
            - "apim.local"
      route:
        - destination:
            host: apim-wso2am-all-in-one-am-service
            port:
              number: 9443
---
# VirtualService for Gateway (SNI based routing)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: gw-vs
  namespace: wso2
spec:
  hosts:
    - "gw.local"
  gateways:
    - istio-system/wso2-gateway
  tls:
    - match:
        - port: 443
          sniHosts:
            - "gw.local"
      route:
        - destination:
            host: apim-gw-wso2am-universal-gw-service
            port:
              number: 8243
