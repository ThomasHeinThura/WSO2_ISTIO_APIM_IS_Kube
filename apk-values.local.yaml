# Copyright (c) 2024, WSO2 LLC. (https://www.wso2.com) All Rights Reserved.
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.

wso2:
  subscription:
    imagePullSecrets: ""

  apk:
    # ========================================
    # Helm Hooks Configuration
    # ========================================
    helmHooks:
      webhooksCleanupEnabled: true
      webhooksCleanup:
        enabled: true
        image: "bitnamilegacy/kubectl:1.31.1"

    # ========================================
    # Webhooks - ENABLED (No Istio conflict)
    # ========================================
    webhooks:
      validatingwebhookconfigurations: true # CHANGED - Enable for APK
      mutatingwebhookconfigurations: true # CHANGED - Enable for APK
      conversionwebhookconfigurations: true # CHANGED - Enable for APK

    # ========================================
    # Authentication & Authorization
    # ========================================
    auth:
      enabled: true
      enableServiceAccountCreation: true
      enableClusterRoleCreation: true
      serviceAccountName: wso2apk-platform
      roleName: wso2apk-role

    # ========================================
    # APK Gateway Listener
    # ========================================
    listener:
      hostname: "api.local"
      port: 9095

    # ========================================
    # Identity Provider - Use APIM CP
    # ========================================
    idp:
      issuer: "https://apim.local/oauth2/token"
      usernameClaim: "sub"
      organizationClaim: "organization"
      groupsClaim: "groups"
      consumerKeyClaim: "clientId"
      organizationResolver: "none"
      signing:
        jwksEndpoint: "https://apim.local/oauth2/jwks"

    # ========================================
    # Control Plane Integration
    # ========================================
    cp:
      enabledSubscription: true
      host: "apim-wso2am-all-in-one-am-service.wso2.svc.cluster.local"
      skipSSLVerification: true

    # ========================================
    # Data Plane Configuration
    # ========================================
    dp:
      enabled: true

      # Gateway Configuration
      gateway:
        listener:
          hostname: "api.local"
          dns:
            - "api.local"
            - "*.api.local"
        service: {}

      # Config Deployer
      configdeployer:
        enabled: true
        deployment:
          resources:
            requests:
              memory: "512Mi"
              cpu: "200m"
            limits:
              memory: "1024Mi"
              cpu: "500m"
          readinessProbe:
            initialDelaySeconds: 20
            periodSeconds: 20
            failureThreshold: 5
          livenessProbe:
            initialDelaySeconds: 20
            periodSeconds: 20
            failureThreshold: 5
          strategy: RollingUpdate
          replicas: 1
          imagePullPolicy: Always
          image: wso2/apk-config-deployer-service:1.3.0

      # Adapter (Converts APIM APIs to K8s Gateway API)
      adapter:
        deployment:
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "300m"
          readinessProbe:
            initialDelaySeconds: 20
            periodSeconds: 20
            failureThreshold: 5
          livenessProbe:
            initialDelaySeconds: 20
            periodSeconds: 20
            failureThreshold: 5
          strategy: RollingUpdate
          replicas: 1
          imagePullPolicy: Always
          image: wso2/apk-adapter:1.3.0
          security:
            sslHostname: "adapter"
          logging:
            level: "INFO"
          configs:
            enableGatewayClassController: true # CHANGED - Enable for standalone
            apiNamespaces:
              - "apk"
              - "wso2"

      # Common Controller
      commonController:
        deployment:
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "300m"
          readinessProbe:
            initialDelaySeconds: 20
            periodSeconds: 20
            failureThreshold: 5
          livenessProbe:
            initialDelaySeconds: 20
            periodSeconds: 20
            failureThreshold: 5
          strategy: RollingUpdate
          replicas: 1
          imagePullPolicy: Always
          image: wso2/apk-common-controller:1.3.0
          security:
            sslHostname: "commoncontroller"
          configs:
            apiNamespaces:
              - "apk"
              - "wso2"

      # Rate Limiter
      ratelimiter:
        enabled: true
        deployment:
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          readinessProbe:
            initialDelaySeconds: 20
            periodSeconds: 20
            failureThreshold: 5
          livenessProbe:
            initialDelaySeconds: 20
            periodSeconds: 20
            failureThreshold: 5
          strategy: RollingUpdate
          replicas: 1
          imagePullPolicy: Always
          image: wso2/apk-ratelimiter:1.3.0
          security:
            sslHostname: "ratelimiter"

      # Gateway Runtime (Router + Enforcer)
      gatewayRuntime:
        deployment:
          replicas: 1

          # Router (Envoy Proxy)
          router:
            resources:
              requests:
                memory: "128Mi"
                cpu: "200m"
              limits:
                memory: "1028Mi"
                cpu: "1000m"
            readinessProbe:
              initialDelaySeconds: 20
              periodSeconds: 20
              failureThreshold: 5
            livenessProbe:
              initialDelaySeconds: 20
              periodSeconds: 20
              failureThreshold: 5
            strategy: RollingUpdate
            imagePullPolicy: Always
            image: wso2/apk-router:1.3.0
            configs:
              logging:
                accessLogs:
                  enable: true
                wireLogs:
                  enable: false

          # Enforcer (Policy Enforcement)
          enforcer:
            resources:
              requests:
                memory: "256Mi"
                cpu: "200m"
              limits:
                memory: "512Mi"
                cpu: "500m"
            readinessProbe:
              initialDelaySeconds: 20
              periodSeconds: 20
              failureThreshold: 5
            livenessProbe:
              initialDelaySeconds: 20
              periodSeconds: 20
              failureThreshold: 5
            strategy: RollingUpdate
            imagePullPolicy: Always
            image: wso2/apk-enforcer:1.3.0
            security:
              sslHostname: "enforcer"
            logging:
              level: INFO
            env:
              TOKEN_REVOCATION_ENABLED: "true"
            configs:
              apiKey:
                enabled: true
                issuer: "https://apim.local/oauth2/token"
              JWKSClient:
                skipSSLVerification: true
                hostnameVerifier: "AllowAll"

    # ========================================
    # Metrics
    # ========================================
    metrics:
      enabled: false

# ========================================
# Built-in IDP (DISABLED - Using APIM CP)
# ========================================
idp:
  enabled: false

# ========================================
# Gateway System (ENABLED - No Istio)
# ========================================
gatewaySystem:
  enabled: true # CHANGED - Enable for standalone APK
  enableServiceAccountCreation: true # CHANGED
  enableClusterRoleCreation: true # CHANGED
  serviceAccountName: gateway-api-admission
  applyGatewayWehbhookJobs: true # CHANGED
  deployment:
    image: registry.k8s.io/gateway-api/admission-server:v1.0.0
    imagePullPolicy: Always

# ========================================
# Cert Manager (ENABLED)
# ========================================
certmanager:
  enabled: true
  enableClusterIssuer: true
  enableRootCa: true
  rootCaSecretName: "apk-root-certificate"

# ========================================
# PostgreSQL Database
# ========================================
postgresql:
  enabled: true
  fullnameOverride: "wso2apk-db-service"
  auth:
    database: WSO2AM_DB
    postgresPassword: wso2carbon
    username: wso2carbon
    password: wso2carbon
  primary:
    extendedConfiguration: |
      max_connections = 400
    initdb:
      scriptsConfigMap: postgres-initdb-scripts-configmap
      user: wso2carbon
      password: wso2carbon
    service:
      ports:
        postgresql: 5432
    podSecurityContext:
      enabled: true
      runAsNonRoot: true
      seccompProfile:
        type: RuntimeDefault
    containerSecurityContext:
      enabled: true
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      runAsUser: null
  image:
    debug: false
    repository: "bitnamilegacy/postgresql"

# ========================================
# Redis Cache
# ========================================
redis:
  enabled: true
  architecture: standalone
  fullnameOverride: redis
  primary:
    service:
      ports:
        redis: 6379
  master:
    podSecurityContext:
      enabled: true
      runAsNonRoot: true
      seccompProfile:
        type: RuntimeDefault
    containerSecurityContext:
      enabled: true
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      runAsUser: null
  auth:
    enabled: false
    usePasswordFiles: false
  image:
    debug: false
    repository: "bitnamilegacy/redis"

# ========================================
# Global Settings
# ========================================
global:
  security:
    allowInsecureImages: true
